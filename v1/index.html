<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Ver.1 - Mirror-based Camera Pose Estimation Using an Orthogonality Constraint</title>

        <link href="../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Mirror-based Camera Pose Estimation Using an Orthogonality Constraint</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Index</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Ver.1</a>
                </li>
            
            
            
                <li >
                    <a href="../v2/">Ver.2</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../v2/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/computer-vision/takahashi2012cvpr">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#introduction">Introduction</a></li>
        
    
        <li class="main "><a href="#how-to-use-the-matlab-version-with-sample-data">How to use the Matlab version with sample data</a></li>
        
            <li><a href="#usage">Usage</a></li>
        
            <li><a href="#brief-descriptions-of-the-code">Brief descriptions of the code</a></li>
        
    
        <li class="main "><a href="#how-to-use-the-opencv-version-with-sample-data">How to use the OpenCV version with sample data</a></li>
        
            <li><a href="#usage_1">Usage</a></li>
        
            <li><a href="#brief-descriptions-of-the-code_1">Brief descriptions of the code</a></li>
        
    
        <li class="main "><a href="#how-to-use-the-code-with-your-own-data">How to use the code with your own data</a></li>
        
    
        <li class="main "><a href="#contact">Contact</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="introduction">Introduction</h1>
<p>This page explains how to use the 3-points version. For the general n-pts version, see <code>matlab/demo.m</code> in <a href="https://github.com/computer-vision/takahashi2012cvpr">GitHub</a>.</p>
<h1 id="how-to-use-the-matlab-version-with-sample-data">How to use the Matlab version with sample data</h1>
<h2 id="usage">Usage</h2>
<p>After unzipping the downloaded file, you will have the following files in a single directory named <code>tnm</code>.</p>
<ul>
<li><code>data/input{1,2,3}.png</code> : Three input images. They are the original pictures WITH lens distortions.</li>
<li><code>data/input{1,2,3}.txt</code> : Three input data points extracted from <code>input{1,2,3}.png</code>. The points are taken from undistorted images.</li>
<li><code>camera.txt</code> : The intrinsic parameter of the camera.</li>
<li><code>model.txt</code> : The reference object.</li>
<li><code>demo.m</code> : A demo program to run our method.</li>
<li><code>tnm.m</code> : An implementation of our calibration method.</li>
<li><code>sub_p3p.m</code> : A sub-function called from <code>tnm.m</code> to solve P3P problem.</li>
<li><code>sub_tnm_orth.m</code> : A sub-function called from <code>tnm.m</code>.</li>
<li><code>sub_tnm_rt.m</code> : A sub-function called from <code>tnm.m</code>.</li>
<li><code>sub_reproj.m</code> : To calc reprojection error.</li>
</ul>
<p>Start Matlab, and change the working directory to the <code>tnm</code> directory. Run <code>demo.m</code> and you should see the following outputs and a pop-up window that visualizes the results.</p>
<pre><code class="matlab">&gt; demo.m
Average reprojection error by TNM : 0.353531 pixel.

==== Parameters by TNM ====
R =
    0.9552   -0.0316   -0.2942
    0.0262    0.9994   -0.0221
    0.2947    0.0134    0.9555
T =
   71.6716
   84.3404
  120.2696
n1 =
    0.2679
    0.0307
   -0.9629
n2 =
    0.4356
    0.0844
   -0.8962
n3 =
   -0.0443
   -0.0112
   -0.9990
d1 =
  386.2302
d2 =
  355.0478
d3 =
  404.7066
</code></pre>

<h2 id="brief-descriptions-of-the-code">Brief descriptions of the code</h2>
<h3 id="tnmm-top-level-driver"><code>tnm.m</code> : top-level driver</h3>
<p>The figure below illustrates the measurement model of our method.</p>
<p><img alt="Geometry" src="../geometry.gif" /></p>
<p>In this figure, we use the following notations. Notice that $${}^Yx$$ denotes $$x$$ in $$Y$$ coordinate system.</p>
<ul>
<li>$$C$$ : camera.</li>
<li>$$\pi_j (j=1,2,3)$$ : three mirrors.</li>
<li>$${}^Cn_j (j=1,2,3)$$ : the normal vector of $$\pi_j$$.</li>
<li>$$d_j (j=1,2,3)$$ : the distance from $$C$$ to $$\pi_j$$.</li>
<li>$${}^Xp^i (i=1,2,3)$$ : three reference points in the reference object coordinate system.</li>
<li>$${}^Cp^i (i=1,2,3)$$ : $${}^Xp^i$$ in the camera $$C$$ coordinate system.</li>
<li>$${}^Cp^i_j (i,j=1,2,3)$$ : Reflection of $${}^Xp^i$$ by $$\pi_j$$ in the camera $$C$$ coordinate system.</li>
<li>$$q^i_j (i,j=1,2,3)$$ : 2D projection of $${}^Cp^i_j$$ in the camera $$C$$ image screen.</li>
</ul>
<p>The goal is to estimate the relative rotation $$R$$ and translation $$T$$ between the camera $$C$$ and the reference $$X$$ which satisfy</p>
<blockquote>
<p>$${}^Cp^i = R \cdot {}^Xp^i + T (i=1,2,3) $$. (1)</p>
</blockquote>
<p>by knowing $$q^i_j (i,j=1,2,3)$$, the projections of $${}^Xp^i$$ observed via three different mirrors $$\pi_j (j=1,2,3)$$ of unknown positions. The orientation and the position of t
he mirrors (the distances from the camera to the mirrors) are also estimated as a result.
So the input / output of the above-mentioned <code>tnm.m</code> can be expressed as follows.</p>
<ul>
<li><code>tnm.m</code><ul>
<li>Input $$q^i_j (i,j=1,2,3)$$ : 2D projections of three reference points observed via three mirrors $$\pi_j (j=1,2,3)$$.</li>
<li>Output:<ul>
<li>$$R, T$$ : The relative posture and position between the camera $$C$$ and the reference $$X$$.</li>
<li>$${}^Cn_j, d_j (j=1,2,3)$$ : The orientations and distances of the three mirrors $$\pi_j (j=1,2,3)$$.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="sub-functions">Sub-functions</h3>
<p>Our mirror-based calibration method consists of the following three steps, and we provide implementations corresponding to them.</p>
<ol>
<li>
<p><code>sub_p3p.m</code>: P3P per mirrored image.</p>
<ul>
<li>Input:<ul>
<li>$${}^Xp^i (i=1,2,3)$$ : Three reference points, and</li>
<li>$$q^i (i)$$ : their projections observed via a mirror $$\pi$$.</li>
</ul>
</li>
<li>Output: Up to 4 possible solutions of $${}^Cp^i$$</li>
</ul>
</li>
<li>
<p><code>sub_tnm_orth.m</code>: Unique solution selection using an orthogonality constraint.</p>
<ul>
<li>Input: 64 sets of $${}^Cp^i_j (i,j=1,2,3)$$.</li>
<li>Output: The set of $${}^Cp^i_j (i,j=1,2,3)$$ which follows the orthogonality constraint best.</li>
</ul>
</li>
<li><code>sub_tnm_rt.m</code>: Linear estimation of $$R$$ and $$T$$.<ul>
<li>Input: $${}^Cp^i_j (i,j=1,2,3)$$.</li>
<li>Output: $$R, T, n_j, d_j (j=1,2,3)$$.</li>
</ul>
</li>
</ol>
<p>And in addition, we use the following sub-function for evaluation purpose.</p>
<ul>
<li><code>sub_reproj.m</code>: Reprojection error evaluation<ul>
<li>Input:<ul>
<li>$${}^Xp^i (i=1,\dots)$$ : Any number of reference points.</li>
<li>$$q^i_j (i=1,\dots, j=1,2,3)$$ : The projections of the reference points via mirrors.</li>
<li>$$R, T, n_j, d_j (j=1,2,3)$$ : Estimated parameters.</li>
</ul>
</li>
<li>Output: Average reprojection error.</li>
</ul>
</li>
</ul>
<h1 id="how-to-use-the-opencv-version-with-sample-data">How to use the OpenCV version with sample data</h1>
<h2 id="usage_1">Usage</h2>
<p>After unzipping the downloaded file, you will have the following files in a single directory named <code>./tnm-opencv</code>.</p>
<ul>
<li><code>data/input{1,2,3}.png</code> : Three input images. They are the original pictures WITH lens distortions.</li>
<li><code>data/input{1,2,3}.txt</code> : Three input data points extracted from input{1,2,3}.png. The points are taken from undistorted images.</li>
<li><code>Makefile</code> : makefile.</li>
<li><code>demo.cc</code> : A demo program to run our method.</li>
<li><code>sub_solveP3P.h</code> : A sub-function called from tnm.h to solve P3P problem.</li>
<li><code>tnm.h</code> : An implementation of our calibration method.</li>
</ul>
<p>This code requires OpenCV 2.3. We used libcv-dev package in <a href="http://packages.debian.org/en/wheezy/libcv-dev">Debian wheezy</a>. For Debian/Ubuntu, try</p>
<pre><code class="sh"> $ sudo apt-get -f install libcv-dev libcvaux-dev libhighgui-dev g++ make
</code></pre>

<p>to install requisite libraries and compilation tools, and then exec</p>
<pre><code class="sh"> $ make
</code></pre>

<p>to compile the code.</p>
<p>For Visual C++ on Windows, please simply import <code>demo.cc</code>, <code>sub_solveP3P.h</code>, and <code>tnm.h</code> into a new project, and compile it (you need to setup additional include path and libraries for Op
enCV, of course).</p>
<p>Once compiled, run the binary (named <code>demo</code>) with no args in the <code>./tnm-opencv</code> directory.</p>
<pre><code class="sh"> $ ./demo
 loading 'data/input1.txt' = [263.854279, 284.595978;
   380.608337, 284.673645;
   261.375946, 355.315582]

 loading 'data/input2.txt' = [187.462204, 264.845764;
   302.664276, 261.313538;
   183.416656, 338.876984]

 loading 'data/input3.txt' = [393.80719, 301.828278;
   529.568542, 311.569794;
   391.23999, 374.259766]

 loading 'data/model.txt' = [0, 0, 0;
   175, 0, 0;
   0, 100, 0]

 loading 'data/camera.txt' = [487.910797, 0, 324.31308;
   0, 487.558441, 237.003937;
   0, 0, 1]


 Average reprojection error by TNM : 0.353531 pixels

 ==== Parameters by TNM ====

 R  = [0.9552278293542109, -0.0315692738655991, -0.2941822138995512;
   0.02622804982091903, 0.9994120031779081, -0.02208477544627536;
   0.294706436016986, 0.01338016634873504, 0.9554941589139341]

 T  = [71.67155976406129; 84.34036742140127; 120.2696306131992]

 n1 = [0.2679446927390354; 0.03066392138399924; -0.9629461903753189]

 n2 = [0.4356434955333516; 0.08437398428883026; -0.8961561111629551]

 n3 = [-0.04427539436835728; -0.01119106464381498; -0.9989566805050478]

 d1 = 386.23

 d2 = 355.048

 d3 = 404.707
</code></pre>

<p>This program automatically loads data from <code>data/input{1,2,3}.txt</code>, and then outputs the estimated parameters to stdout.</p>
<h2 id="brief-descriptions-of-the-code_1">Brief descriptions of the code</h2>
<p>The structure of the code is very straightforward. Please visit the <code>main()</code> function in <code>demo.cc</code> first. The flow of <code>main()</code> is:</p>
<ol>
<li>load data from files (<code>model.txt</code>, <code>input{1,2,3}.txt</code>) by <code>load()</code> function defined in <code>demo.cc</code>.</li>
<li>run calibration by <code>tnm()</code> function defined in tnm.h. What this function does inside is:</li>
<li>call <code>sub_solveP3P()</code> defined in <code>sub_solveP3P.h</code> for each input data (= the Matlab function in <code>tnm-matlab/sub_p3p.m</code>),</li>
<li>call <code>sub_tnm_orth()</code> defined in <code>tnm.h</code> (= the Matlab function in <code>tnm-matlab/sub_tnm_orth.m</code>), and</li>
<li>call <code>sub_tnm_rt()</code> defined in <code>tnm.h</code> (= the Matlab function in <code>tnm-matlab/sub_tnm_rt.m</code>).</li>
<li>run <code>sub_reproj()</code> defined in <code>demo.cc</code> to evaluate the reprojection error (= the Matlab function in <code>tnm-matlab/sub_reproj.m</code>).</li>
</ol>
<p>So to re-use the code for your own project, copy <code>tnm.h</code> and <code>sub_solveP3P.h</code>, and then use <code>tnm()</code> for calibration. To understand how to prepare the data, please consult the <code>load()</code> f
unction in <code>demo.cc</code>.</p>
<h1 id="how-to-use-the-code-with-your-own-data">How to use the code with your own data</h1>
<p>To calibrate your own system, please follow the process below. In short, update <code>data/model.txt</code> and <code>data/input{1,2,3}.txt</code>, then run the program again.</p>
<ol>
<li>Suppose you have a reference object $$X$$ and a camera $$C$$.<ol>
<li>The intrinsic parameters of $$C$$ should be provided. You can use OpenCV to estimate them.</li>
</ol>
</li>
<li>Capture three images of $$X$$ as $$I_1, I_2, I_3$$ via mirrors $$\pi_1, \pi_2, \pi_3$$ under different poses.</li>
<li>Detect three points of $$X$$ for each of the images ($$I_1, I_2, I_3$$).<ol>
<li>Here we assume that the images are rectified (undistorted) using the intrinsic parameters before the detection.</li>
<li>If you used a chessboard pattern as $$X$$ and used OpenCV <a href="http://docs.opencv.org/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html#findch
essboardcorners">findChessboardCorners()</a> to detect it in $$I_1, I_2, I_3$$ automatically, you need to <strong>flip</strong> the detection result because the detector does not account for the observation via mirror.</li>
</ol>
</li>
<li>
<p>Store the data into <code>data/model.txt</code> and <code>data/input{1,2,3}.txt</code>.</p>
<ol>
<li><code>data/model.txt</code> is a line-oriented plain text file each of lines represents the 3D position of a reference point in $$X$$.<pre><code>0.000000 0.000000 0.000000
175.000000 0.000000 0.000000
0.000000 100.000000 0.000000
</code></pre>
</li>
</ol>
</li>
<li>
<p><code>data/input{1,2,3}.txt</code> are also line-oriented plain text files, and each of lines represents the 2D projection of the corresponding 3D reference point in <code>data/model.txt</code>. For examp
le, the first line below is the projection of the first reference point $$(0,0,0)$$ defined in the first line of <code>data/model.txt</code>.</p>
<pre><code>380.608337 284.673645
263.854279 284.595978
377.368225 350.688141
</code></pre>
</li>
<li>
<p>Exec the demo program again, and you will get the result.</p>
</li>
</ol>
<h1 id="contact">Contact</h1>
<ul>
<li><a href="http://vision.kuee.kyoto-u.ac.jp/~nob/">Shohei NOBUHARA</a></li>
</ul></div>
        </div>

	<footer class="col-md-12">
		<hr>
		
		<p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
	</footer>


        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="../mathjax.js"></script>
    </body>
</html>